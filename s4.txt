WITH file_data AS (
    SELECT
        console_path,
        file_path,
        file_name,
        CAST(keywords[cardinality(keywords)] AS BIGINT) AS file_size_bytes
    FROM "data_retention_uat"."policy_document_metadata"
    WHERE keywords IS NOT NULL
      AND cardinality(keywords) > 0
      AND TRY_CAST(keywords[cardinality(keywords)] AS BIGINT) IS NOT NULL
      AND CAST(keywords[cardinality(keywords)] AS BIGINT) <= 1073741824
),
ordered_files AS (
    SELECT
        *,
        ROW_NUMBER() OVER (ORDER BY CAST(keywords[cardinality(keywords)] AS BIGINT) DESC) AS rn
    FROM file_data
),
running_total AS (
    SELECT
        console_path,
        file_path,
        file_name,
        file_size_bytes,
        SUM(file_size_bytes) OVER (ORDER BY rn) AS cumulative_bytes
    FROM ordered_files
),
safe_batching AS (
    SELECT
        *,
        CAST(FLOOR((cumulative_bytes - 1) / 1073741824) + 1 AS INTEGER) AS batch_number
    FROM running_total
)
SELECT
    batch_number AS batch_id,
    COUNT(*) AS file_count,
    ROUND(SUM(file_size_bytes) / (1024.0 * 1024.0 * 1024.0), 3) AS total_size_gb,
    ROUND(SUM(file_size_bytes) / (1024.0 * 1024.0), 0) AS total_size_mb,
    CASE
        WHEN SUM(file_size_bytes) > 1073741824 THEN 'EXCEEDS_LIMIT'
        WHEN SUM(file_size_bytes) < 104857600 THEN 'LOW_UTILIZATION'
        ELSE 'COMPLIANT'
    END AS batch_status
FROM safe_batching
GROUP BY batch_number
ORDER BY batch_number;
